
###########################################################################
## Process the time series for plotting, remove date columns and convert units
###########################################################################
paleo_ts_plot <- reactive({
	if (list_id()=="None"){
		### Generate a blank graph
		paleo_ts_temp <- data.frame(Observed=rep(NA,300), Annual_Recon=rep(NA,300), Monthly_Recon=rep(NA,300))
		paleo_ts_plot <- ts(as.matrix(paleo_ts_temp), start=c(1700,1), frequency=12)
	} else {
	### Remove the monthly and annual columns before plotting
		paleo_ts_plot <- paleo_ts_subset()[,cols_to_scale()]
	}
### Return time series for plot
	paleo_ts_plot
})

###########################################################################
## Prepare for download
###########################################################################
 output$downloadData <- downloadHandler(
    filename = function() { paste(site_info()$col_name, '_',flow_units(),'.csv', sep='') },
    content = function(file) {
      write.csv(paleo_ts_subset(), file)
    }
  )

###########################################################################
## Calculate maximum flow for plotting range
###########################################################################
y_lims <- reactive({ 
	max_y <- max(c(paleo_ts_plot()), na.rm=TRUE)
	max_y <- 1.1*max_y
	c(0,max_y) 
	})




###########################################################################
## Output to time series plot
########################################################################### 

  
  observe({
  if (input$time_resolution == "monthly") {
  
 output$tsPlot <-  renderDygraph({
    dygraph(paleo_ts_plot(), main = site_name()) %>%
    dyRangeSelector()  %>%
   # dyRangeSelector(dateWindow = c("1850-01-01", "1995-01-01")) %>%
    dyOptions(axisLineWidth = 1.5, drawGrid = FALSE, titleHeight= 28) %>%
    dyLegend(show = "always", hideOnMouseOut = FALSE, labelsSeparateLines=TRUE) %>%
    dyAxis("y", label = paste0("Monthly Mean Discharge (",flow_units(),")"), valueRange=y_lims()) %>%
    dySeries("Observed", color="#e41a1c", strokeWidth=0.8)  %>%
    dySeries("Monthly_Recon", color="#404040", strokeWidth = 0.8) %>% 
    dySeries("Annual_Recon", color="#377eb8", strokeWidth = 1.2, strokePattern = "dashed") %>%
    dyCallbacks(drawCallback = dyRegister())
  	})      
  } else {
  
  output$tsPlot <-  renderDygraph({
    dygraph(paleo_ts_plot(), main = site_name()) %>%
    dyRangeSelector()  %>%
   # dyRangeSelector(dateWindow = c("1850-01-01", "1995-01-01")) %>%
    dyOptions(axisLineWidth = 1.5, drawGrid = FALSE, titleHeight= 28) %>%
    dyLegend(show = "always", hideOnMouseOut = FALSE, labelsSeparateLines=TRUE) %>%
    dyAxis(name="x",axisLabelFormatter = "function(d){ return d.getFullYear() }"  ) %>%
    dyAxis("y", label = paste0("Annual Mean Discharge (",flow_units(),")"), valueRange=y_lims()) %>%
    dySeries("Observed", color="#e41a1c", strokeWidth=0.8)  %>%
    dySeries("Annual_Recon", color="#404040", strokeWidth = 0.8) %>%
    dyCallbacks(drawCallback = dyRegister())
  	})    
  }

    }) 
    


